name: Rust + Debian Package

on:
  push:
    tags:
      - 'v*'  # 只有 push tag 才触发
  workflow_dispatch:
    inputs:
      arch:
        description: 'Target architecture'
        required: true
        default: 'amd64'

env:
  CARGO_TERM_COLOR: always
  TARGET_DIR: target/release
  DEB_DIR: package/deb

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake pkg-config fakeroot dpkg-dev jq

    - name: Build Rust project
      run: cargo build --release

    - name: Run tests
      run: cargo test --verbose

    - name: Set package info
      id: pkg_info
      run: |
        PACKAGE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
        MAINTAINER=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].authors[0]')
        DESCRIPTION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].description // "No description"')
        ARCH=${{ github.event.inputs.arch || 'amd64' }}
        # 取触发的 Git tag 作为版本
        if [ -n "${GITHUB_REF##refs/tags/}" ]; then
          PACKAGE_VERSION="${GITHUB_REF##refs/tags/}"
        else
          PACKAGE_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
        fi
        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
        echo "MAINTAINER=$MAINTAINER" >> $GITHUB_ENV
        echo "DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV
        echo "ARCH=$ARCH" >> $GITHUB_ENV

    - name: Prepare DEB structure
      run: |
        mkdir -p ${DEB_DIR}/usr/local/bin
        cp ${TARGET_DIR}/relayfetch ${DEB_DIR}/usr/local/bin/
        mkdir -p ${DEB_DIR}/var/lib/relayfetch
        mkdir -p ${DEB_DIR}/var/log/relayfetch

    - name: Set control file
      run: |
        echo "Package: ${PACKAGE_NAME}" > ${DEB_DIR}/DEBIAN/control
        echo "Version: ${PACKAGE_VERSION}" >> ${DEB_DIR}/DEBIAN/control
        echo "Section: utils" >> ${DEB_DIR}/DEBIAN/control
        echo "Priority: optional" >> ${DEB_DIR}/DEBIAN/control
        echo "Architecture: ${ARCH}" >> ${DEB_DIR}/DEBIAN/control
        echo "Maintainer: ${MAINTAINER}" >> ${DEB_DIR}/DEBIAN/control
        echo "Description: ${DESCRIPTION}" >> ${DEB_DIR}/DEBIAN/control

    - name: Build DEB package
      run: |
        fakeroot dpkg-deb --build ${DEB_DIR} ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb

    - name: Create or update GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload DEB to Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
