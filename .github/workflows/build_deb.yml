name: Rust + Debian Package (Cross-compile)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  DEB_DIR: package/deb
  CC_armv7_unknown_linux_gnueabihf: arm-linux-gnueabihf-gcc
  CXX_armv7_unknown_linux_gnueabihf: arm-linux-gnueabihf-g++
  CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER: arm-linux-gnueabihf-gcc
  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
  CC_aarch64_unknown_linux-gnu: aarch64-linux-gnu-gcc
  CXX_aarch64_unknown_linux-gnu: aarch64-linux-gnu-g++

jobs:
  build-deb:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64, armv7]
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake pkg-config fakeroot dpkg-dev jq protobuf-compiler gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    - name: Install cross toolchains
      run: |
        case "${{ matrix.arch }}" in
          amd64) TARGET=x86_64-unknown-linux-gnu ;;
          arm64) TARGET=aarch64-unknown-linux-gnu ;;
          armv7) TARGET=armv7-unknown-linux-gnueabihf ;;
        esac
        rustup target add $TARGET
        echo "TARGET=$TARGET" >> $GITHUB_ENV

    - name: Build Rust project
      run: |
        cargo build --release --target $TARGET

    - name: Run tests
      run: |
        # 测试默认本机架构即可，交叉编译架构无法直接运行
        if [ "${{ matrix.arch }}" = "amd64" ]; then
          cargo test --verbose
        fi

    - name: Set package info
      id: pkg_info
      run: |
        PACKAGE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
        MAINTAINER=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].authors[0]')
        DESCRIPTION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].description // "No description"')
        PACKAGE_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
        ARCH=${{ matrix.arch }}
        # PACKAGE_VERSION="${GITHUB_REF##refs/tags/}"
        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
        echo "MAINTAINER=$MAINTAINER" >> $GITHUB_ENV
        echo "DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV
        echo "ARCH=$ARCH" >> $GITHUB_ENV

    - name: Prepare DEB structure
      run: |
        mkdir -p ${DEB_DIR}/usr/local/bin
        cp target/$TARGET/release/relayfetch ${DEB_DIR}/usr/local/bin/
        mkdir -p ${DEB_DIR}/var/lib/relayfetch
        mkdir -p ${DEB_DIR}/var/log/relayfetch

    - name: Set control file
      run: |
        echo "Package: ${PACKAGE_NAME}" > ${DEB_DIR}/DEBIAN/control
        echo "Version: ${PACKAGE_VERSION}" >> ${DEB_DIR}/DEBIAN/control
        echo "Section: utils" >> ${DEB_DIR}/DEBIAN/control
        echo "Priority: optional" >> ${DEB_DIR}/DEBIAN/control
        echo "Architecture: ${ARCH}" >> ${DEB_DIR}/DEBIAN/control
        echo "Maintainer: ${MAINTAINER}" >> ${DEB_DIR}/DEBIAN/control
        echo "Description: ${DESCRIPTION}" >> ${DEB_DIR}/DEBIAN/control

    - name: Build DEB package
      run: |
        fakeroot dpkg-deb --build ${DEB_DIR} ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb

    - name: Create or update GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload DEB to Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
