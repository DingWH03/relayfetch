syntax = "proto3";

package management;

service Management {
  rpc Ping(PingRequest) returns (PingResponse);
  rpc ReloadConfig(ReloadConfigRequest) returns (ReloadConfigResponse);
  rpc TriggerSync(TriggerSyncRequest) returns (TriggerSyncResponse);
  rpc CleanUnusedFiles(CleanUnusedFilesRequest) returns (CleanUnusedFilesResponse);
  rpc Status(StatusRequest) returns (StatusResponse);
  rpc GetConfig(GetConfigRequest) returns (GetConfigResponse);
  rpc UpdateConfig(UpdateConfigRequest) returns (UpdateConfigResponse);
  rpc ListFiles(ListFilesRequest) returns (ListFilesResponse);
  rpc UpdateFiles(UpdateFilesRequest) returns (UpdateFilesResponse);
}

message FileInfo {
  string filename = 1;
  string url = 2;
  string last_modified = 3;
}
message ListFilesRequest {}
message ListFilesResponse {
  repeated FileInfo files = 1;
}

// 单个文件项
message FileItem {
  string filename = 1;
  string path = 2; // URL
}

// 请求：可以新增、删除或者覆盖
message UpdateFilesRequest {
  repeated FileItem add_files = 1;       // 新增或更新
  repeated string remove_files = 2;      // 删除
  bool replace_all = 3;                  // true = 替换整个列表
  repeated FileItem new_files = 4;       // replace_all = true 时使用
}

// 响应
message UpdateFilesResponse {
  string message = 1;
}

message PingRequest {}
message PingResponse { string message = 1; }

message ReloadConfigRequest {}
message ReloadConfigResponse { string message = 1; }

message TriggerSyncRequest {}
message TriggerSyncResponse { string message = 1; }

message CleanUnusedFilesRequest {}
message CleanUnusedFilesResponse { repeated string removed = 1; }

message StatusRequest {}
message FileProgress {
  string file = 1;          // 文件名
  uint64 downloaded = 2;    // 已下载字节
  uint64 total = 3;         // 总字节 (0 表示未知)
  bool done = 4;            // 是否完成
  string error = 5;         // 错误信息 (空字符串表示无错)
}
enum SyncResult {
  PENDING = 0;
  SUCCESS = 1;
  PARTIAL_SUCCESS = 2;
  FAILED = 3;
}
message StatusResponse {
  bool is_running = 1;
  uint32 total_files = 2;
  uint32 finished_files = 3;
  uint32 failed_files = 4;
  uint32 stored_files = 5;

  uint64 start_time_unix = 6;
  uint64 last_sync_unix = 7;
  uint64 last_ok_sync_unix = 8;
  SyncResult last_result = 9;

  repeated FileProgress files = 10;
  string storage_dir = 11;
  string error_message = 12;
}

message GetConfigRequest {}
message GetConfigResponse {
  string storage_dir = 1;
  string bind = 2;
  string grpc_admin = 3;
  string http_admin = 4;
  string proxy = 5;
  string url = 6;
  uint32 interval_secs = 7;
  uint32 download_concurrency = 8;
  uint32 download_retry = 9;
  uint32 retry_base_delay_ms = 10;
}

message UpdateConfigRequest {
  optional uint32 interval_secs = 1;
  optional string storage_dir = 2;
  optional string url = 3;
  optional string bind = 4;
  optional string grpc_admin = 5;
  optional string http_admin = 6;
  optional string proxy = 7; // 空字符串表示清空
  optional uint32 download_concurrency = 8;
  optional uint32 download_retry = 9;
  optional uint32 retry_base_delay_ms = 10;
}
message UpdateConfigResponse {
  string message = 1;
}